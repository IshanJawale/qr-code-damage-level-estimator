<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Damage Estimator</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <h1>QR Code Damage Estimator</h1>
        
        <div class="upload-section">
            <div class="upload-box">
                <h3>Upload Image</h3>
                <input type="file" id="fileInput" accept="image/*">
                <label for="fileInput" class="btn">Choose File</label>
                <p class="filename" id="fileName">No file chosen</p>
            </div>

            <div class="upload-box">
                <h3>Camera Capture</h3>
                <button id="cameraBtn" class="btn">Open Camera</button>
                <button id="captureBtn" class="btn" style="display:none;">Capture</button>
                <button id="closeCamera" class="btn secondary" style="display:none;">Close</button>
            </div>
        </div>

        <div id="cameraContainer" style="display:none;">
            <video id="video" autoplay playsinline></video>
            <canvas id="canvas" style="display:none;"></canvas>
        </div>

        <div id="preview" style="display:none;">
            <h3>Preview</h3>
            <img id="previewImage" alt="Preview">
            <button id="analyzeBtn" class="btn primary">Analyze</button>
        </div>

        <div id="loading" style="display:none;">
            <div class="spinner"></div>
            <p>Analyzing...</p>
        </div>

        <div id="results" style="display:none;">
            <h2>Results</h2>
            <div class="result-box">
                <div class="badge" id="badge">
                    <span id="className">-</span>
                </div>
                <div class="confidence">
                    <span id="confidence">-</span>
                    <small>confidence</small>
                </div>
            </div>
            
            <div class="probabilities">
                <h3>Probabilities</h3>
                <div id="probBars"></div>
            </div>

            <button id="resetBtn" class="btn">Analyze Another</button>
        </div>

        <div id="error" style="display:none;">
            <p id="errorText"></p>
        </div>
    </div>

    <script>
        const fileInput = document.getElementById('fileInput');
        const fileName = document.getElementById('fileName');
        const cameraBtn = document.getElementById('cameraBtn');
        const captureBtn = document.getElementById('captureBtn');
        const closeCamera = document.getElementById('closeCamera');
        const cameraContainer = document.getElementById('cameraContainer');
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const preview = document.getElementById('preview');
        const previewImage = document.getElementById('previewImage');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const loading = document.getElementById('loading');
        const results = document.getElementById('results');
        const error = document.getElementById('error');
        const errorText = document.getElementById('errorText');
        const resetBtn = document.getElementById('resetBtn');

        let stream = null;
        let currentImage = null;

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                fileName.textContent = file.name;
                const reader = new FileReader();
                reader.onload = (e) => {
                    previewImage.src = e.target.result;
                    currentImage = file;
                    preview.style.display = 'block';
                    results.style.display = 'none';
                    stopCamera();
                };
                reader.readAsDataURL(file);
            }
        });

        cameraBtn.addEventListener('click', async () => {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                video.srcObject = stream;
                cameraContainer.style.display = 'block';
                cameraBtn.style.display = 'none';
                captureBtn.style.display = 'inline-block';
                closeCamera.style.display = 'inline-block';
                preview.style.display = 'none';
                results.style.display = 'none';
            } catch (err) {
                showError('Camera access denied');
            }
        });

        captureBtn.addEventListener('click', () => {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            canvas.toBlob((blob) => {
                currentImage = blob;
                previewImage.src = canvas.toDataURL('image/jpeg');
                preview.style.display = 'block';
                stopCamera();
            }, 'image/jpeg', 0.95);
        });

        closeCamera.addEventListener('click', stopCamera);

        function stopCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            cameraContainer.style.display = 'none';
            cameraBtn.style.display = 'inline-block';
            captureBtn.style.display = 'none';
            closeCamera.style.display = 'none';
        }

        analyzeBtn.addEventListener('click', async () => {
            if (!currentImage) return;

            loading.style.display = 'block';
            results.style.display = 'none';
            error.style.display = 'none';

            try {
                let response;
                
                if (currentImage instanceof File) {
                    const formData = new FormData();
                    formData.append('file', currentImage);
                    response = await fetch('/predict', { method: 'POST', body: formData });
                } else {
                    const base64 = canvas.toDataURL('image/jpeg');
                    response = await fetch('/predict', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ image: base64 })
                    });
                }

                const data = await response.json();
                if (data.success) {
                    displayResults(data);
                } else {
                    showError(data.error);
                }
            } catch (err) {
                showError('Analysis failed');
            } finally {
                loading.style.display = 'none';
            }
        });

        function displayResults(data) {
            document.getElementById('className').textContent = data.class_name;
            document.getElementById('confidence').textContent = data.confidence.toFixed(1) + '%';

            const badge = document.getElementById('badge');
            badge.className = 'badge ' + data.class_name.toLowerCase();

            const probBars = document.getElementById('probBars');
            probBars.innerHTML = '';
            
            data.probabilities.forEach(prob => {
                const bar = document.createElement('div');
                bar.className = 'prob-bar';
                bar.innerHTML = `
                    <span>${prob.class_name}</span>
                    <div class="bar-wrapper">
                        <div class="bar" style="width: ${prob.probability}%"></div>
                    </div>
                    <span>${prob.probability.toFixed(1)}%</span>
                `;
                probBars.appendChild(bar);
            });

            results.style.display = 'block';
        }

        function showError(message) {
            errorText.textContent = message;
            error.style.display = 'block';
            setTimeout(() => error.style.display = 'none', 3000);
        }

        resetBtn.addEventListener('click', () => {
            results.style.display = 'none';
            preview.style.display = 'none';
            fileInput.value = '';
            fileName.textContent = 'No file chosen';
            currentImage = null;
        });
    </script>
</body>
</html>
